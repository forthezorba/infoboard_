<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
 
<mapper namespace="com.example.info.mapper.BoardMapper">
    
    <select id="dashInfo" resultType="com.example.info.domain.DashInfo">
        SELECT 
			(SELECT COUNT(bno) FROM board) AS totalBoard
			,(SELECT COUNT(email) FROM bael_users) AS totalMember
			,(SELECT COUNT(*) FROM board b,bael_users u 
				WHERE b.writer=u.email
				AND bno=ref
				AND reply=0
			) as unanswered
			,(SELECT COUNT(*) FROM board b,bael_users u 
				WHERE b.writer=u.email
				AND date_format(b.reg_date,'%Y-%m-%d')=DATE(NOW())
			) AS newboard
		FROM
			DUAL;
    </select>
    
    <select id="boardCount" resultType="int">
        SELECT
            COUNT(bno)
        FROM BOARD
    </select>
    
    <select id="boardList" resultType="com.example.info.domain.BoardVO">
        SELECT *
	        FROM BOARD 
	        ORDER BY REF DESC,BNO ASC
    </select>
    
    
    <sql id="criteria">
		<trim prefix="(" suffix=")" prefixOverrides="OR">
			<foreach item='type' collection="typeArr">
				<trim prefix="OR">
					<choose>
						<when test="type == 'G'.toString()">
							subject like CONCAT('%', #{keyword}, '%')
						</when>
						<when test="type == 'T'.toString()">
							content like CONCAT('%', #{keyword}, '%')
						</when>
						<when test="type == 'C'.toString()">
							writer like CONCAT('%', #{keyword}, '%')
						</when>
						<when test="type == 'W'.toString()">
							name like CONCAT('%', #{keyword}, '%')
						</when>
					</choose>
				</trim>
			</foreach>
		</trim>
	</sql> 
    
    <select id="boardListWithCri" resultType="com.example.info.domain.BoardVO">
        SELECT *
	        FROM BOARD 
	        WHERE 
	        <include refid="criteria"></include>
	        ORDER BY REF DESC,BNO ASC
    </select>
    
    <select id="boardDetail" parameterType="int" resultType="com.example.info.domain.BoardVO">
        SELECT
            *
	        FROM BOARD
	        WHERE BNO = #{bno}
            
    </select>
    
    <insert id="boardInsert" parameterType="com.example.info.domain.BoardVO">
        <selectKey keyProperty="ref" order="BEFORE" resultType="int">
				select ifnull(max(bno)+1, 1) from BOARD
		</selectKey>
        INSERT INTO
	        BOARD (BNO,REF,REPLY,SUBJECT,CONTENT,WRITER,NAME,REG_DATE)
	        VALUES(#{ref},#{ref},#{reply},#{subject},#{content},#{writer},#{name},now()) 
    </insert>
    
    <insert id="boardReInsert" parameterType="com.example.info.domain.BoardVO">
        INSERT INTO
	        BOARD (BNO,REF,REPLY,SUBJECT,CONTENT,WRITER,NAME,REG_DATE)
	        VALUES(#{bno},#{ref},#{reply},#{subject},#{content},#{writer},#{name},now()) 
    </insert>
    
    <update id="boardOriginUpdate" parameterType="com.example.info.domain.BoardVO">
        UPDATE BOARD
	        SET REPLY = REPLY+1
	        WHERE BNO = #{ref}
    </update>
    
    <update id="boardUpdate" parameterType="com.example.info.domain.BoardVO">
        UPDATE BOARD
            SET
       		<if test="subject != null">
            SUBJECT = #{subject}
       	 	</if>
     	    <if test="subject != null and content != null"> , </if>
     	    <if test="content != null">
            CONTENT = #{content}
     	    </if>
        	WHERE BNO = #{bno}
    </update>
    
    <delete id="boardDelete" parameterType="int">
        DELETE FROM BOARD WHERE BNO = #{bno}
    </delete>

</mapper>


